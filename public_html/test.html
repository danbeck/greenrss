<!doctype>
<html>
    <head>
        <script>
            EMAIL = "XXX";
            PASSWD = "XXX";
            THEOLDREADER_API_URL = "https://theoldreader.com/reader/api/0/";

            window.onload = function() {
                var testbutton = document.getElementById("testbutton");
                testbutton.onclick = function()
                {

                    var categoryElement = document.getElementById("categories");
                    categoryElement.innerHTML = "";
                    var subscriptionsElement = document.getElementById("subscriptions");
                    subscriptionsElement.innerHTML = "";
                    theoldreader_getLoginToken(theoldReader_drawCategories);
                };

                function theoldReader_drawCategories(token) {
                    theoldreader_getCategories(token, drawCategory);
                    theoldreader_getSubscriptionList(token, drawSubscription);

                }

                function drawCategory(label, id) {
//                    theoldreader_getCategories(token, );
                    var categoryElement = document.getElementById("categories");
                    var liElement = document.createElement("li");
                    liElement.innerHTML = label + " - " + id;
                    categoryElement.appendChild(liElement);
                }

                function drawSubscription(subscription) {
//                    theoldreader_getCategories(token, );
                    var subscriptionElement = document.getElementById("subscriptions");
                    var liElement = document.createElement("li");
                    liElement.innerHTML = subscription.id + " - " + subscription.title + " - " +
                            subscription.sortid + "-" + subscription.firstitemmsec + "-"
                            + subscription.url + "-" + subscription.htmlUrl + "-" + subscription.iconUrl;
                    var catHTML = "";
                    for (var i = 0; i < subscription.categories.length; i++) {
                        catHTML += subscription.categories[i] + " II ";
                    }

                    subscriptionElement.appendChild(liElement);
                }

                function theoldreader_getCategories(token, onCategory) {
                    var xhr = new XMLHttpRequest();
                    xhr.open("GET", THEOLDREADER_API_URL + "tag/list?output=json", true);
                    xhr.setRequestHeader('Content-type', 'application/x-www-form-urlencoded;');
                    xhr.setRequestHeader('Authorization', 'GoogleLogin auth=' + token);

                    xhr.onreadystatechange = function(e) {
                        if (xhr.readyState !== 4)
                            return;
                        if (xhr.readyState === 4 && xhr.status === 200) {
                            var response = JSON.parse(xhr.responseText);
                            var tagsArray = response.tags;//[{"id":"user/-/label/Science","sortid":"51d425bd82d4932d3c00001d"}...]
                            for (var i = 0; i < tagsArray.length; i++) {
                                var label = tagsArray[i].id.substr(13);
                                var id = tagsArray[i].sortid;
                                onCategory(label, id);
                            }
                        }
                    };
                    xhr.send();

                }

                function theoldreader_getSubscriptionList(token, onSubscription) {
                    var xhr = new XMLHttpRequest();
                    xhr.open("GET", THEOLDREADER_API_URL + "subscription/list?output=json", true);
                    xhr.setRequestHeader('Content-type', 'application/x-www-form-urlencoded;');
                    xhr.setRequestHeader('Authorization', 'GoogleLogin auth=' + token);

                    xhr.onreadystatechange = function(e) {
                        if (xhr.readyState !== 4)
                            return;
                        if (xhr.readyState === 4 && xhr.status === 200) {
                            var response = JSON.parse(xhr.responseText);
//                            "{"subscriptions":[{"id":"feed/51d406556f48ea85c900000c","title":"Changing Bits","categories":[],"sortid":"51d406556f48ea85c900000c","firstitemmsec":"1376596357295","url":"http://blog.mikemccandless.com/feeds/posts/default","htmlUrl":"http://blog.mikemccandless.com/","iconUrl":"https://theoldreader.com/system/uploads/feed/picture/5141/93cc/e721/ece3/fe06/icon_1c27.ico"},
//                                              {"id":"feed/51d40685d1716c54ad000046","title":"GOG.com News","categories":[],"sortid":"51d40685d1716c54ad000046","firstitemmsec":"1377092059472","url":"http://www.gog.com/frontpage/rss","htmlUrl":"http://www.gog.com/frontpage/rss","iconUrl":"https://theoldreader.com/system/uploads/feed/picture/50e2/ea13/e721/ec34/2000/icon_18f5.ico"}
                            var subscriptions = response.subscriptions;
                            for (var i = 0; i < subscriptions.length; i++) {
//                                var id = subscriptions[i].id.substr(5);
                                onSubscription(subscriptions[i]);
                            }
                        }
                    };
                    xhr.send();

                }

                function theoldreader_getLoginToken(gotToken) {
                    var xhr = new XMLHttpRequest();
                    xhr.open("POST", THEOLDREADER_API_URL + "accounts/ClientLogin", true);

                    xhr.setRequestHeader('Content-type', 'application/x-www-form-urlencoded;');
                    xhr.onreadystatechange = function(e) {
                        if (xhr.readyState !== 4)
                            return;
                        if (xhr.readyState === 4 && xhr.status === 200) {
                            var response = JSON.parse(xhr.responseText);
                            gotToken(response.Auth);
                        }
                    };
                    xhr.send("output=json&client=RamSamSamReader&accountType=HOSTED&service=reader&Email=" + EMAIL + "&Passwd=" + PASSWD);
                }
            };</script>
    </head>
    <body>
        <p><button id="testbutton">Hit me!</button></p>
        <div><ul id="categories"></ul></div>
        <div><ul id="subscriptions"></ul></div>
    </body>
